# Generated by Django 4.1.8 on 2023-04-27 10:58

from django.db import migrations, models


def migrate_forwards(apps, schema_editor):
    Highlight = apps.get_model("highlights", "Highlight")
    PageHighlight = apps.get_model("collections", "PageHighlight")
    highlights_by_image_id = {
        obj.teaser_image_id: obj
        for obj in Highlight.objects.all().filter(teaser_image__isnull=False)
    }
    for obj in PageHighlight.objects.all():
        try:
            highlight = highlights_by_image_id[obj.image_id]
            obj.highlight = highlight
            obj.save(update_fields=["highlight"])
        except KeyError:
            obj.delete()
        else:
            # Copy the 'alt_text' value to the highlight instance
            highlight.alt_text = obj.alt_text
            highlight.save(update_fields=["alt_text"])


def migrate_backwards(apps, schema_editor):
    PageHighlight = apps.get_model("collections", "PageHighlight")
    for obj in PageHighlight.objects.filter(highlight__isnull=False):
        obj.highlight = None
        obj.save(update_fields=["highlight"])


class Migration(migrations.Migration):
    dependencies = [
        ("collections", "0054_add_pagehighlight_highlight"),
        ("highlights", "0005_create_highlights_from_images"),
    ]

    operations = [
        migrations.RunPython(migrate_forwards, migrate_backwards),
    ]
